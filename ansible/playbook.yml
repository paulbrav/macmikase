# Main Ansible playbook for macmikase
# Configures a macOS workstation with Homebrew packages, runtimes, web apps, and dotfiles
---
- name: Configure macOS workstation
  hosts: localhost
  connection: local
  become: false
  gather_facts: true

  vars:
    config_file: >-
      {{ lookup('env', 'MACMIKASE_CONFIG')
         | default(lookup('env', 'CONFIG_FILE') | default('../macmikase.yaml', true), true) }}
    macmikase_config: "{{ lookup('file', config_file) | from_yaml }}"

    defaults: "{{ macmikase_config.defaults | default({}) }}"
    brew: "{{ macmikase_config.brew | default({}) }}"
    cask: "{{ macmikase_config.cask | default({}) }}"
    web: "{{ macmikase_config.web | default({}) }}"
    npm_packages: "{{ macmikase_config.npm | default([]) }}"
    uv_tools: "{{ macmikase_config.uv_tools | default([]) }}"
    cargo_tools: "{{ macmikase_config.cargo_tools | default([]) }}"
    go_tools: "{{ macmikase_config.go_tools | default([]) }}"
    themes: "{{ macmikase_config.themes | default({}) }}"

    # Paths
    local_bin: "{{ ansible_env.HOME }}/.local/bin"
    local_share: "{{ ansible_env.HOME }}/.local/share"
    config_dir: "{{ ansible_env.HOME }}/.config"
    themes_dir: "{{ local_share }}/macmikase/themes"

    homebrew_prefix: "{{ '/opt/homebrew' if ansible_facts['architecture'] == 'arm64' else '/usr/local' }}"
    brew_bin: "{{ homebrew_prefix }}/bin/brew"

  pre_tasks:
    - name: "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      ansible.builtin.debug:
        msg: "â›©ï¸  MACMIKASE INSTALLATION STARTING"
      tags: [always]

    - name: Display configuration source
      ansible.builtin.debug:
        msg: "Loading configuration from: {{ config_file }}"
      tags: [always]

    - name: Check for /opt/homebrew brew binary
      ansible.builtin.stat:
        path: /opt/homebrew/bin/brew
      register: brew_arm_stat

    - name: Check for /usr/local brew binary
      ansible.builtin.stat:
        path: /usr/local/bin/brew
      register: brew_intel_stat

    - name: Resolve Homebrew prefix for this host
      ansible.builtin.set_fact:
        homebrew_prefix: >-
          {{ '/opt/homebrew' if brew_arm_stat.stat.exists
             else ('/usr/local' if brew_intel_stat.stat.exists
                   else ('/opt/homebrew' if ansible_facts['architecture'] == 'arm64' else '/usr/local')) }}
        brew_bin: >-
          {{ '/opt/homebrew/bin/brew' if brew_arm_stat.stat.exists
             else ('/usr/local/bin/brew' if brew_intel_stat.stat.exists
                   else (('/opt/homebrew' if ansible_facts['architecture'] == 'arm64' else '/usr/local') ~ '/bin/brew')) }}

    - name: Show resolved Homebrew location
      ansible.builtin.debug:
        msg: "Using Homebrew at: {{ brew_bin }}"
      tags: [always]

    - name: Check for Homebrew
      ansible.builtin.stat:
        path: "{{ brew_bin }}"
      register: brew_stat

    - name: Install Homebrew (if missing)
      ansible.builtin.shell: |
        set -euo pipefail
        installer="$(mktemp /tmp/homebrew-install.XXXXXX.sh)"
        trap 'rm -f "$installer"' EXIT
        curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh -o "$installer"
        /bin/bash "$installer"
      args:
        executable: /bin/bash
        creates: "{{ brew_bin }}"
      when: not brew_stat.stat.exists

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Phase 1: Homebrew Packages & Casks
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: "ğŸ“¦ [1/4] INSTALLING HOMEBREW PACKAGES"
      ansible.builtin.debug:
        msg: "Installing Homebrew formulae and casks..."
      tags: [homebrew]

    - name: Include homebrew role
      ansible.builtin.include_role:
        name: homebrew
      tags: [homebrew]

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Phase 2: Language Runtimes & Tools
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: "ğŸ”§ [2/4] INSTALLING RUNTIMES & TOOLS"
      ansible.builtin.debug:
        msg: "Installing runtimes and developer tools..."
      tags: [runtimes]

    - name: Include runtimes role
      ansible.builtin.include_role:
        name: runtimes
      tags: [runtimes]

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Phase 3: Web Apps
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: "ğŸŒ [3/4] CREATING WEB APP SHORTCUTS"
      ansible.builtin.debug:
        msg: "Creating macOS app wrappers for web apps..."
      tags: [web]

    - name: Include web role
      ansible.builtin.include_role:
        name: web
      tags: [web]

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Phase 4: Dotfiles
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: "ğŸ“ [4/4] APPLYING DOTFILES"
      ansible.builtin.debug:
        msg: "Configuring shell, editor, and application settings..."
      tags: [dotfiles]

    - name: Include dotfiles role
      ansible.builtin.include_role:
        name: dotfiles
      tags: [dotfiles]

  post_tasks:
    - name: "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      ansible.builtin.debug:
        msg: "âœ… MACMIKASE INSTALLATION COMPLETE!"

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                    ğŸ‰ Installation Complete!                    â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                                 â”‚
          â”‚  Next steps:                                                    â”‚
          â”‚  â€¢ Run 'macmikase-theme <name>' to switch themes                â”‚
          â”‚  â€¢ Run 'macmikase' for the interactive menu                     â”‚
          â”‚                                                                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
