# Dotfiles role: Install and apply dotfiles using chezmoi
---
# ==========================================================================
# Install chezmoi
# ==========================================================================

- name: Check if chezmoi is installed
  ansible.builtin.command:
    cmd: which chezmoi
  register: dotfiles_chezmoi_check
  changed_when: false
  failed_when: dotfiles_chezmoi_check.rc > 1

- name: Download chezmoi installer
  ansible.builtin.get_url:
    url: https://get.chezmoi.io
    dest: /tmp/chezmoi-install.sh
    mode: "0755"
  when: dotfiles_chezmoi_check.rc != 0

- name: Install chezmoi
  ansible.builtin.command:
    cmd: /tmp/chezmoi-install.sh -b {{ local_bin }}
  when: dotfiles_chezmoi_check.rc != 0
  changed_when: true

- name: Clean up chezmoi installer
  ansible.builtin.file:
    path: /tmp/chezmoi-install.sh
    state: absent
  when: dotfiles_chezmoi_check.rc != 0

# ==========================================================================
# Sync themes
# ==========================================================================

- name: Create themes directory
  ansible.builtin.file:
    path: "{{ themes_dir }}"
    state: directory
    mode: "0755"

- name: Sync themes from repository
  ansible.posix.synchronize:
    src: "{{ playbook_dir }}/../themes/"
    dest: "{{ themes_dir }}/"
    recursive: true
    delete: false
  delegate_to: localhost

# ==========================================================================
# Install bin scripts
# ==========================================================================

- name: Create local bin directory
  ansible.builtin.file:
    path: "{{ local_bin }}"
    state: directory
    mode: "0755"

- name: Create local share directory
  ansible.builtin.file:
    path: "{{ local_share }}"
    state: directory
    mode: "0755"

- name: Install all macmikase bin scripts
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../bin/{{ item }}"
    dest: "{{ local_bin }}/{{ item }}"
    mode: "0755"
    remote_src: true
  loop:
    - macmikase-lib.sh
    - macmikase-theme
    - macmikase-theme-cursor
    - macmikase-theme-terminal
    - macmikase
    - macmikase-install
    - macmikase-databases
    - macmikase-update
    - macmikase-cursor-extensions

# ==========================================================================
# Initialize and apply chezmoi
# ==========================================================================

- name: Create chezmoi config directory
  ansible.builtin.file:
    path: "{{ config_dir }}/chezmoi"
    state: directory
    mode: "0755"

- name: Configure chezmoi with theme data
  ansible.builtin.copy:
    content: |
      sourceDir = "{{ playbook_dir }}/../chezmoi"

      [data]
          theme = "{{ defaults.theme | default('nord') }}"
          themes_dir = "{{ themes_dir }}"
          font_family = "JetBrainsMono Nerd Font"
          font_size = 12
          padding = 12
    dest: "{{ config_dir }}/chezmoi/chezmoi.toml"
    mode: "0644"

- name: Initialize chezmoi with source directory
  ansible.builtin.command:
    cmd: "{{ local_bin }}/chezmoi init --source={{ playbook_dir }}/../chezmoi --apply=false"
  args:
    creates: "{{ local_share }}/chezmoi/.chezmoi.toml.tmpl"
  environment:
    PATH: "{{ local_bin }}:{{ ansible_env.PATH }}"

- name: Apply chezmoi dotfiles
  ansible.builtin.command:
    cmd: "{{ local_bin }}/chezmoi apply --force"
  environment:
    PATH: "{{ local_bin }}:{{ ansible_env.PATH }}"
  register: dotfiles_chezmoi_apply
  changed_when: false

# ==========================================================================
# Shell integration
# ==========================================================================

- name: Add Homebrew and macmikase to .zprofile
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zprofile"
    marker: "# {mark} MACMIKASE MANAGED BLOCK"
    block: |
      # macmikase
      export PATH="{{ local_bin }}:$PATH"
      if [ -x "/opt/homebrew/bin/brew" ]; then
        eval "$("/opt/homebrew/bin/brew" shellenv)"
      elif [ -x "/usr/local/bin/brew" ]; then
        eval "$("/usr/local/bin/brew" shellenv)"
      fi
    create: true
    mode: "0644"

- name: Add macmikase to .zshrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    marker: "# {mark} MACMIKASE MANAGED BLOCK"
    block: |
      # macmikase
      export PATH="{{ local_bin }}:$PATH"
      if [ -x "/opt/homebrew/bin/brew" ]; then
        eval "$("/opt/homebrew/bin/brew" shellenv)"
      elif [ -x "/usr/local/bin/brew" ]; then
        eval "$("/usr/local/bin/brew" shellenv)"
      fi
      [ -f "{{ config_dir }}/shell/macmikase.sh" ] && source "{{ config_dir }}/shell/macmikase.sh"
    create: true
    mode: "0644"

- name: Add macmikase to .bashrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    marker: "# {mark} MACMIKASE MANAGED BLOCK"
    block: |
      # macmikase
      export PATH="{{ local_bin }}:$PATH"
      if [ -x "/opt/homebrew/bin/brew" ]; then
        eval "$("/opt/homebrew/bin/brew" shellenv)"
      elif [ -x "/usr/local/bin/brew" ]; then
        eval "$("/usr/local/bin/brew" shellenv)"
      fi
      [ -f "{{ config_dir }}/shell/macmikase.sh" ] && source "{{ config_dir }}/shell/macmikase.sh"
    create: true
    mode: "0644"

# ==========================================================================
# Install theme-tui
# ==========================================================================

- name: Check if uv is available
  ansible.builtin.command:
    cmd: which uv
  register: dotfiles_uv_check
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ local_bin }}:{{ homebrew_prefix }}/bin:{{ ansible_env.PATH }}"

- name: Install theme-tui via uv
  ansible.builtin.command:
    cmd: "{{ dotfiles_uv_check.stdout }} tool install --reinstall {{ playbook_dir }}/.."
  environment:
    PATH: "{{ local_bin }}:{{ homebrew_prefix }}/bin:{{ ansible_env.PATH }}"
  when: dotfiles_uv_check.rc == 0
  register: dotfiles_theme_tui_install
  changed_when: "'Installed' in dotfiles_theme_tui_install.stdout"

# ==========================================================================
# Install Cursor/VS Code extensions
# ==========================================================================

- name: Check if cursor command is available
  ansible.builtin.command:
    cmd: which cursor
  register: dotfiles_cursor_check
  changed_when: false
  failed_when: false

- name: Check if code command is available
  ansible.builtin.command:
    cmd: which code
  register: dotfiles_code_check
  changed_when: false
  failed_when: false
  when: dotfiles_cursor_check.rc != 0

- name: Set editor command
  ansible.builtin.set_fact:
    dotfiles_editor_cmd: "{{ 'cursor' if dotfiles_cursor_check.rc == 0 else ('code' if dotfiles_code_check.rc | default(1) == 0 else '') }}"

- name: Install Cursor/VS Code extensions  # noqa: risky-shell-pipe
  ansible.builtin.shell: |
    set -e
    EXTENSIONS_FILE="{{ ansible_env.HOME }}/Library/Application Support/Cursor/extensions.txt"
    if [[ ! -f "$EXTENSIONS_FILE" ]]; then
      EXTENSIONS_FILE="{{ ansible_env.HOME }}/Library/Application Support/Code/extensions.txt"
    fi
    if [[ ! -f "$EXTENSIONS_FILE" ]]; then
      echo "Extensions file not found"
      exit 0
    fi
    grep -v '^\s*#' "$EXTENSIONS_FILE" | grep -v '^\s*$' | while read -r ext; do
      {{ dotfiles_editor_cmd }} --install-extension "$ext" --force 2>/dev/null || true
    done
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ local_bin }}:{{ homebrew_prefix }}/bin:{{ ansible_env.PATH }}"
  when: dotfiles_editor_cmd != ''
  register: dotfiles_extensions_install
  changed_when: false
