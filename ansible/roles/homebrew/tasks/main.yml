# Homebrew role: Install brew formulae and cask applications
---
- name: Collect brew packages
  ansible.builtin.set_fact:
    brew_packages: >-
      {{ (brew_packages | default([]))
         + (item.value
            | selectattr('install', 'defined')
            | selectattr('install', 'equalto', true)
            | map(attribute='name')
            | list)
         + (item.value
            | rejectattr('install', 'defined')
            | map(attribute='name')
            | list) }}
  loop: "{{ brew | default({}) | dict2items }}"
  when: brew is mapping

- name: Tap oven-sh/bun (required for bun)
  community.general.homebrew_tap:
    name: oven-sh/bun
    state: present
  when: brew_packages is defined and "bun" in brew_packages
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_env.PATH }}"

- name: Install brew packages
  community.general.homebrew:
    name: "{{ brew_packages | default([]) | unique }}"
    state: present
  when: brew_packages is defined and brew_packages | length > 0
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_env.PATH }}"

- name: Collect cask packages
  ansible.builtin.set_fact:
    cask_packages: >-
      {{ (cask_packages | default([]))
         + (item.value
            | selectattr('install', 'defined')
            | selectattr('install', 'equalto', true)
            | map(attribute='name')
            | list)
         + (item.value
            | rejectattr('install', 'defined')
            | map(attribute='name')
            | list) }}
  loop: "{{ cask | default({}) | dict2items }}"
  when: cask is mapping

- name: Install cask applications
  community.general.homebrew_cask:
    name: "{{ cask_packages | default([]) | unique }}"
    state: present
    sudo_password: "{{ macmikase_sudo_password if (macmikase_sudo_password | default('') | length > 0) else omit }}"
  when: cask_packages is defined and cask_packages | length > 0
  environment:
    PATH: "{{ homebrew_prefix }}/bin:{{ ansible_env.PATH }}"
