# Runtimes role: Configure language runtimes and developer tools on macOS
---
- name: Ensure local bin directory exists
  ansible.builtin.file:
    path: "{{ local_bin }}"
    state: directory
    mode: "0755"

- name: Check for rustup
  ansible.builtin.stat:
    path: "{{ homebrew_prefix }}/bin/rustup"
  register: runtimes_rustup

- name: Check for rustc
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.cargo/bin/rustc"
  register: runtimes_rustc

- name: Initialize Rust toolchain (stable)
  ansible.builtin.shell: |
    "{{ homebrew_prefix }}/bin/rustup" toolchain install stable
    "{{ homebrew_prefix }}/bin/rustup" default stable
  args:
    executable: /bin/bash
  when:
    - runtimes_rustup.stat.exists
    - not runtimes_rustc.stat.exists
  changed_when: true

- name: Re-check for rustc after rustup bootstrap
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.cargo/bin/rustc"
  register: runtimes_rustc_post
  when: runtimes_rustup.stat.exists

- name: Install cargo tools
  ansible.builtin.shell: |
    source "{{ ansible_env.HOME }}/.cargo/env"
    if ! command -v cargo &>/dev/null; then
      echo "cargo not available"
      exit 0
    fi
    if ! command -v {{ item.name }} &>/dev/null; then
      cargo install --locked {{ item.name }}
      echo "installed"
    else
      echo "already installed"
    fi
  args:
    executable: /bin/bash
  loop: "{{ cargo_tools | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list + cargo_tools | default([]) | rejectattr('install', 'defined') | list }}"
  when:
    - cargo_tools is defined and cargo_tools | length > 0
    - (runtimes_rustc_post is defined and runtimes_rustc_post.stat.exists) or runtimes_rustc.stat.exists
  loop_control:
    label: "{{ item.name }}"
  changed_when: "'installed' in stdout"

- name: Check for go
  ansible.builtin.command:
    cmd: which go
  register: runtimes_go_check
  changed_when: false
  failed_when: false

- name: Install go tools
  ansible.builtin.shell: |
    export PATH="{{ homebrew_prefix }}/bin:{{ ansible_env.HOME }}/go/bin:$PATH"
    if ! command -v {{ item.name }} &>/dev/null; then
      go install {{ item.package }}
      echo "installed"
    else
      echo "already installed"
    fi
  args:
    executable: /bin/bash
  loop: "{{ go_tools | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list + go_tools | default([]) | rejectattr('install', 'defined') | list }}"
  when:
    - go_tools is defined and go_tools | length > 0
    - runtimes_go_check.rc == 0
  loop_control:
    label: "{{ item.name }}"
  changed_when: "'installed' in stdout"

- name: Normalize npm packages
  ansible.builtin.set_fact:
    npm_list: "{{ (npm_list | default([])) + [ (item if item is mapping else {'name': item}) ] }}"
  loop: "{{ npm_packages | default([]) }}"

- name: Install npm global packages
  ansible.builtin.shell: |
    if ! command -v npm &>/dev/null; then
      echo "npm not available"
      exit 0
    fi
    pkg="{{ item.name }}"
    ver="{{ item.version | default('latest') }}"
    npm install -g "${pkg}@${ver}"
  args:
    executable: /bin/bash
  loop: "{{ npm_list | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list + npm_list | default([]) | rejectattr('install', 'defined') | list }}"
  when: npm_list is defined and npm_list | length > 0
  loop_control:
    label: "{{ item.name }}"
  changed_when: true

- name: Check for uv
  ansible.builtin.stat:
    path: "{{ homebrew_prefix }}/bin/uv"
  register: runtimes_uv

- name: Normalize uv tools
  ansible.builtin.set_fact:
    uv_list: "{{ (uv_list | default([])) + [ (item if item is mapping else {'name': item}) ] }}"
  loop: "{{ uv_tools | default([]) }}"

- name: Install uv tools
  ansible.builtin.shell: |
    "{{ homebrew_prefix }}/bin/uv" tool install --reinstall {{ item.name }}
  args:
    executable: /bin/bash
  loop: "{{ uv_list | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list + uv_list | default([]) | rejectattr('install', 'defined') | list }}"
  when:
    - runtimes_uv.stat.exists
    - uv_list is defined and uv_list | length > 0
  loop_control:
    label: "{{ item.name }}"
  changed_when: true
