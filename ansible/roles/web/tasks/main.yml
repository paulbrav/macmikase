# Web role: Create macOS app wrappers for web apps
---
- name: Create web apps directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/Applications/Macmikase Web Apps"
    state: directory
    mode: "0755"

- name: Collect enabled web apps
  ansible.builtin.set_fact:
    web_apps_enabled: "{{ web.apps | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list + web.apps | default([]) | rejectattr('install', 'defined') | list }}"

- name: Create app wrappers
  ansible.builtin.shell: |
    set -e
    app_dir="{{ ansible_env.HOME }}/Applications/Macmikase Web Apps"
    app_name="{{ item.name }}"
    app_path="$app_dir/${app_name}.app"
    url="{{ item.url }}"
    /usr/bin/osacompile -o "$app_path" << EOF
    on run
        do shell script "open '${url}'"
    end run
    EOF
  args:
    executable: /bin/bash
  loop: "{{ web_apps_enabled | default([]) }}"
  when: web_apps_enabled | length > 0
  loop_control:
    label: "{{ item.name }}"
  changed_when: true

- name: Apply custom icons to app wrappers
  ansible.builtin.shell: |
    set -euo pipefail
    app_dir="{{ ansible_env.HOME }}/Applications/Macmikase Web Apps"
    app_name="{{ item.name }}"
    app_path="$app_dir/${app_name}.app"
    icon_url="{{ item.icon_url | default('') }}"

    if [[ -z "$icon_url" ]]; then
      exit 0
    fi

    if [[ ! -d "$app_path" ]]; then
      echo "Warning: App bundle not found: $app_path"
      exit 0
    fi

    work_dir="$(mktemp -d)"
    icon_src="$work_dir/source"
    icon_png="$work_dir/icon.png"
    iconset="$work_dir/Icon.iconset"
    mkdir -p "$iconset"

    if ! /usr/bin/curl -fsSL "$icon_url" -o "$icon_src"; then
      echo "Warning: Failed to download icon for $app_name"
      rm -rf "$work_dir"
      exit 0
    fi

    if ! /usr/bin/sips -s format png "$icon_src" --out "$icon_png" >/dev/null; then
      echo "Warning: Failed to convert icon for $app_name"
      rm -rf "$work_dir"
      exit 0
    fi

    /usr/bin/sips -z 16 16 "$icon_png" --out "$iconset/icon_16x16.png" >/dev/null
    /usr/bin/sips -z 32 32 "$icon_png" --out "$iconset/icon_16x16@2x.png" >/dev/null
    /usr/bin/sips -z 32 32 "$icon_png" --out "$iconset/icon_32x32.png" >/dev/null
    /usr/bin/sips -z 64 64 "$icon_png" --out "$iconset/icon_32x32@2x.png" >/dev/null
    /usr/bin/sips -z 128 128 "$icon_png" --out "$iconset/icon_128x128.png" >/dev/null
    /usr/bin/sips -z 256 256 "$icon_png" --out "$iconset/icon_128x128@2x.png" >/dev/null
    /usr/bin/sips -z 256 256 "$icon_png" --out "$iconset/icon_256x256.png" >/dev/null
    /usr/bin/sips -z 512 512 "$icon_png" --out "$iconset/icon_256x256@2x.png" >/dev/null
    /usr/bin/sips -z 512 512 "$icon_png" --out "$iconset/icon_512x512.png" >/dev/null
    /usr/bin/sips -z 1024 1024 "$icon_png" --out "$iconset/icon_512x512@2x.png" >/dev/null

    if /usr/bin/iconutil -c icns "$iconset" -o "$work_dir/applet.icns"; then
      cp "$work_dir/applet.icns" "$app_path/Contents/Resources/applet.icns"
    else
      echo "Warning: Failed to build icns for $app_name"
    fi

    rm -rf "$work_dir"
  args:
    executable: /bin/bash
  loop: "{{ web_apps_enabled | default([]) }}"
  when:
    - web_apps_enabled | length > 0
    - item.icon_url is defined
    - item.icon_url | length > 0
  loop_control:
    label: "{{ item.name }}"
  changed_when: true
  failed_when: false
