#!/usr/bin/env zsh
# macmikase-install - Japanese cyberpunk themed system installer for macOS
if [ -z "${ZSH_VERSION:-}" ]; then
    exec zsh "$0" "$@"
fi
emulate -L zsh
set -euo pipefail
setopt no_nomatch

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SCRIPT_NAME="$(basename "$0")"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
DEFAULT_CONFIG_FILE="$REPO_DIR/macmikase.yaml"
CONFIG_FILE="${CONFIG_FILE:-${MACMIKASE_CONFIG:-$DEFAULT_CONFIG_FILE}}"
LOG_FILE="/tmp/macmikase-install-$(date +%Y%m%d-%H%M%S).log"
SUDO_KEEPALIVE_PID=""
UI_MODE="${MACMIKASE_UI:-fancy}"

log_line() {
    # Best-effort structured log line for installer-level events.
    local level="$1"
    shift
    if [[ -n "${LOG_FILE:-}" ]]; then
        printf '[%s] [%s] %s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$level" "$*" >> "$LOG_FILE"
    fi
}

safe_clear() {
    clear >/dev/null 2>&1 || printf '\033c' >/dev/null 2>&1 || true
}

list_config_names() {
    local section="$1"
    local group="${2:-}"

    if [[ -n "$group" ]]; then
        (
            cd "$REPO_DIR" && \
            uv run macmikase-config --config "$CONFIG_FILE" list "$section" "$group" --names-only 2>/dev/null
        ) || true
    else
        (
            cd "$REPO_DIR" && \
            uv run macmikase-config --config "$CONFIG_FILE" list "$section" --names-only 2>/dev/null
        ) || true
    fi
}

print_plan_group() {
    local title="$1"
    local section="$2"
    local group="${3:-}"
    local limit="${4:-8}"
    local -a items
    local line
    local count
    local shown
    local i

    items=()
    while IFS= read -r line; do
        [[ -n "$line" ]] || continue
        items+=("$line")
    done < <(list_config_names "$section" "$group")
    count="${#items[@]}"

    if (( count == 0 )); then
        return
    fi

    gum style --foreground "$NEON_CYAN" "  â€¢ $title ($count)"
    shown=$count
    if (( shown > limit )); then
        shown=$limit
    fi

    for (( i=1; i<=shown; i++ )); do
        gum style --foreground "$DIM" "      - ${items[$i]}"
    done

    if (( count > shown )); then
        gum style --foreground "$DIM" "      - ... and $((count - shown)) more"
    fi

    log_line "INFO" "Plan $title count=$count"
}

show_install_plan() {
    local theme
    theme="$(
        cd "$REPO_DIR" && \
        uv run macmikase-config --config "$CONFIG_FILE" get defaults.theme --default nord 2>/dev/null
    )"
    if [[ -z "$theme" ]]; then
        theme="nord"
    fi

    echo ""
    gum style --foreground "$NEON_PINK" "  ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«äºˆå®š / Install plan"
    gum style --foreground "$DIM" "  Theme: $theme"
    log_line "INFO" "Plan theme=$theme"

    print_plan_group "Brew Core" "brew" "core" 8
    print_plan_group "Brew Dev" "brew" "dev" 8
    print_plan_group "Casks (Apps)" "cask" "apps" 8
    print_plan_group "Casks (Terminal)" "cask" "terminal" 6
    print_plan_group "Casks (Fonts)" "cask" "fonts" 6
    print_plan_group "Cargo Tools" "cargo_tools" "" 8
    print_plan_group "Go Tools" "go_tools" "" 8
    print_plan_group "UV Tools" "uv_tools" "" 8
    print_plan_group "NPM Globals" "npm" "" 8
    print_plan_group "Web Apps" "web" "apps" 8
    echo ""
}

has_cask_installs() {
    local group
    for group in terminal apps fonts; do
        if list_config_names "cask" "$group" | sed '/^[[:space:]]*$/d' | head -n 1 | grep -q .; then
            return 0
        fi
    done
    return 1
}

start_sudo_keepalive() {
    (
        while true; do
            sudo -n true >/dev/null 2>&1 || exit 0
            sleep 60
        done
    ) &
    SUDO_KEEPALIVE_PID="$!"
}

stop_sudo_keepalive() {
    if [[ -n "${SUDO_KEEPALIVE_PID:-}" ]]; then
        kill "$SUDO_KEEPALIVE_PID" >/dev/null 2>&1 || true
        wait "$SUDO_KEEPALIVE_PID" 2>/dev/null || true
        SUDO_KEEPALIVE_PID=""
    fi
    unset MACMIKASE_SUDO_PASSWORD
}

ensure_sudo_session() {
    local sudo_password

    if ! has_cask_installs; then
        log_line "INFO" "No cask installs detected; skipping sudo pre-auth"
        return 0
    fi

    if ! command -v sudo >/dev/null 2>&1; then
        log_line "ERROR" "sudo command not available but cask installs requested"
        gum style --foreground "$NEON_RED" "  âœ— sudo is required for cask installs"
        return 1
    fi

    gum style --foreground "$NEON_CYAN" "  ç®¡ç†è€…èªè¨¼ãŒå¿…è¦ã§ã™ (Homebrew casks)"

    sudo_password="${MACMIKASE_SUDO_PASSWORD:-}"
    if [[ -z "$sudo_password" ]]; then
        sudo_password="$(gum input --password --prompt "  Administrator password: " --placeholder "Required for Homebrew casks")"
    fi

    if [[ -z "$sudo_password" ]]; then
        log_line "ERROR" "sudo password input was empty"
        gum style --foreground "$NEON_RED" "  âœ— sudo password is required"
        return 1
    fi

    if ! printf '%s\n' "$sudo_password" | sudo -S -k -v >/dev/null 2>&1; then
        log_line "ERROR" "sudo authentication failed"
        gum style --foreground "$NEON_RED" "  âœ— sudo authentication failed"
        return 1
    fi

    export MACMIKASE_SUDO_PASSWORD="$sudo_password"
    start_sudo_keepalive
    log_line "INFO" "sudo authenticated, password exported for cask tasks, keepalive started (pid=$SUDO_KEEPALIVE_PID)"
    return 0
}

usage() {
    cat << EOF
Usage: $SCRIPT_NAME [options]

Options:
  -c, --config PATH   Path to macmikase.yaml (default: $CONFIG_FILE)
  -h, --help          Show this help message
EOF
}

while [[ $# -gt 0 ]]; do
    case "$1" in
        -c|--config)
            if [[ -z "${2:-}" ]]; then
                echo "Error: --config requires a path." >&2
                usage
                exit 1
            fi
            CONFIG_FILE="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            usage
            exit 1
            ;;
    esac
done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Colors - Cyberpunk Palette
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
NEON_PINK="212"
NEON_CYAN="51"
NEON_PURPLE="99"
NEON_GREEN="82"
NEON_ORANGE="208"
NEON_RED="196"
DIM="241"

find_brew_binary() {
    if command -v brew >/dev/null 2>&1; then
        command -v brew
        return 0
    fi
    if [[ -x /opt/homebrew/bin/brew ]]; then
        echo "/opt/homebrew/bin/brew"
        return 0
    fi
    if [[ -x /usr/local/bin/brew ]]; then
        echo "/usr/local/bin/brew"
        return 0
    fi
    return 1
}

activate_brew_shellenv() {
    local brew_cmd
    brew_cmd="$(find_brew_binary || true)"
    if [[ -z "$brew_cmd" ]]; then
        return 1
    fi
    eval "$("$brew_cmd" shellenv)"
}

ensure_brew() {
    if find_brew_binary >/dev/null 2>&1; then
        activate_brew_shellenv || true
        return
    fi
    echo "Homebrew not found. Installing..."
    local installer="/tmp/homebrew-install.sh"
    if ! curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh -o "$installer"; then
        echo "Error: failed to download Homebrew installer." >&2
        exit 1
    fi
    /bin/bash "$installer"
    rm -f "$installer"
    if ! activate_brew_shellenv; then
        echo "Error: Homebrew installation succeeded, but brew is not available on PATH." >&2
        exit 1
    fi
}

ensure_gum() {
    if command -v gum >/dev/null 2>&1; then
        return
    fi
    echo "gum not found. Installing..."
    local brew_cmd
    brew_cmd="$(find_brew_binary || true)"
    if [[ -z "$brew_cmd" ]]; then
        echo "Error: brew is required to install gum." >&2
        exit 1
    fi
    "$brew_cmd" install gum
}

ensure_uv() {
    if command -v uv >/dev/null 2>&1; then
        return
    fi
    if [[ -x "$HOME/.local/bin/uv" ]]; then
        export PATH="$HOME/.local/bin:$PATH"
        return
    fi
    if [[ -x /opt/homebrew/bin/uv ]]; then
        export PATH="/opt/homebrew/bin:$PATH"
        return
    fi
    if [[ -x /usr/local/bin/uv ]]; then
        export PATH="/usr/local/bin:$PATH"
        return
    fi
    echo "uv not found. Installing..."
    curl -LsSf https://astral.sh/uv/install.sh -o /tmp/uv-install.sh
    sh /tmp/uv-install.sh
    rm /tmp/uv-install.sh
    export PATH="$HOME/.local/bin:$PATH"
    if ! command -v uv >/dev/null 2>&1; then
        echo "Error: uv installation completed, but uv is not available on PATH." >&2
        exit 1
    fi
}

resolve_repo_dir() {
    if [[ -f "$REPO_DIR/ansible/playbook.yml" ]]; then
        return
    fi
    if [[ -f "$PWD/ansible/playbook.yml" ]]; then
        REPO_DIR="$PWD"
        if [[ "$CONFIG_FILE" == "$DEFAULT_CONFIG_FILE" ]]; then
            CONFIG_FILE="$REPO_DIR/macmikase.yaml"
        fi
    fi
}

validate_inputs() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        gum style --foreground "$NEON_RED" "  âœ— Config not found: $CONFIG_FILE"
        exit 1
    fi
    CONFIG_FILE="$(cd "$(dirname "$CONFIG_FILE")" && pwd)/$(basename "$CONFIG_FILE")"

    if [[ ! -f "$REPO_DIR/ansible/playbook.yml" ]]; then
        gum style --foreground "$NEON_RED" "  âœ— ansible/playbook.yml not found under: $REPO_DIR"
        gum style --foreground "$DIM" "  Run 'make install' from the repository root."
        exit 1
    fi
}

ensure_ansible_collections() {
    local requirements_file="$REPO_DIR/ansible/requirements.yml"
    if [[ ! -f "$requirements_file" ]]; then
        return 0
    fi

    if gum spin \
        --spinner.foreground "$NEON_PINK" \
        --title.foreground "$NEON_CYAN" \
        --spinner dot \
        --title "  ä¾å­˜é–¢ä¿‚... ansible collections" \
        -- zsh -c "uv run --extra dev ansible-galaxy collection install -r '$requirements_file' >> '$LOG_FILE' 2>&1"; then
        gum style --foreground "$NEON_GREEN" "  âœ“ ansible collections"
        return 0
    fi

    gum style --foreground "$NEON_RED" "  âœ— ansible collections - $LOG_FILE"
    return 1
}

banner() {
    if [[ "$UI_MODE" != "fancy" ]]; then
        safe_clear
        echo
        gum style --foreground "$NEON_PINK" --bold "== MACMIKASE INSTALLER =="
        gum style --foreground "$DIM" "macOS System Configuration"
        echo
        return
    fi

    local p="\033[38;5;${NEON_PURPLE}m"
    local r="\033[0m"
    local pink="\033[38;5;${NEON_PINK}m"
    local cyan="\033[38;5;${NEON_CYAN}m"
    local dim="\033[38;5;${DIM}m"
    local width=76
    local line
    local len
    local left
    local right

    safe_clear
    echo ""
    echo -e "  ${p}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${r}"

    for line in \
        "â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—" \
        "â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•" \
        "â–‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•â•â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘" \
        "â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–‘â•šâ•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–‘â•šâ•â•â•â–ˆâ–ˆâ•—" \
        "â–‘â–ˆâ–ˆâ•‘â–‘â•šâ•â•â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â•šâ•â•â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•" \
        "â–‘â•šâ•â•â–‘â–‘â–‘â–‘â–‘â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â•â•â•â•â–‘â–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â–‘â–‘â–‘â•šâ•â•â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â•â•â•â•"; do
        len=${#line}
        left=$(( (width - len) / 2 ))
        right=$(( width - len - left ))
        printf "  %bâ•‘%b%*s%s%*s%bâ•‘%b\n" "$p" "$pink" "$left" "" "$line" "$right" "" "$p" "$r"
    done

    echo -e "  ${p}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${r}"

    line="SYSTEM SETTINGS"
    len=${#line}
    left=$(( (width - len) / 2 ))
    right=$(( width - len - left ))
    printf "  %bâ•‘%b%*s%s%*s%bâ•‘%b\n" "$p" "$cyan" "$left" "" "$line" "$right" "" "$p" "$r"

    line="macOS System Configuration"
    len=${#line}
    left=$(( (width - len) / 2 ))
    right=$(( width - len - left ))
    printf "  %bâ•‘%b%*s%s%*s%bâ•‘%b\n" "$p" "$dim" "$left" "" "$line" "$right" "" "$p" "$r"

    echo -e "  ${p}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${r}"
    echo ""
}

phase_header() {
    local num="$1"
    local total="$2"
    local title="$3"
    local subtitle="$4"

    if [[ "$UI_MODE" != "fancy" ]]; then
        echo
        gum style --foreground "$NEON_PINK" --bold "[$num/$total] $title"
        gum style --foreground "$DIM" "  $subtitle"
        return
    fi

    local c="\033[38;5;${NEON_CYAN}m"
    local r="\033[0m"

    echo ""
    echo -e "  ${c}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${r}"

    local inner_phase
    inner_phase=$(gum style --width 76 --align left \
        "$(echo -e "  \033[38;5;${NEON_PINK}m[$num/$total] $title\033[0m")" \
        "$(echo -e "        \033[38;5;${DIM}m$subtitle\033[0m")")

    while IFS= read -r line; do
        echo -e "  ${c}â”‚${r}${line}${c}â”‚${r}"
    done <<< "$inner_phase"

    echo -e "  ${c}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${r}"
}

run_ansible() {
    local tags="$1"
    local desc="$2"
    local phase_log
    local rc

    phase_log="$(mktemp -t "macmikase-${tags}")"
    if [[ -z "$phase_log" ]]; then
        log_line "ERROR" "Failed to create temporary phase log for tag=$tags"
        gum style --foreground "$NEON_RED" "  âœ— å¤±æ•— - unable to create temporary log file"
        return 1
    fi

    cd "$REPO_DIR/ansible"
    log_line "INFO" "Starting phase tag=$tags desc=$desc"

    # Homebrew can require sudo password entry; run in foreground with TTY so prompts work.
    if [[ "$tags" == "homebrew" ]] && has_cask_installs; then
        gum style --foreground "$DIM" "  Running homebrew phase in foreground (sudo prompts enabled)"
        uv run --extra dev ansible-playbook -i inventory.yml playbook.yml \
            -e "config_file=$CONFIG_FILE" \
            --tags "$tags" \
            2>&1 | tee "$phase_log"
        rc=${pipestatus[1]}
    else
        gum spin \
            --spinner.foreground "$NEON_PINK" \
            --title.foreground "$NEON_CYAN" \
            --spinner dot \
            --title "  å‡¦ç†ä¸­... $desc" \
            -- zsh -c "uv run --extra dev ansible-playbook -i inventory.yml playbook.yml \
                -e 'config_file=$CONFIG_FILE' \
                --tags '$tags' > '$phase_log' 2>&1"
        rc=$?
    fi

    if [[ "$rc" -eq 0 ]]; then
        cat "$phase_log" >> "$LOG_FILE"

        # Guardrail: a tagged phase must execute role tasks, not only include_role.
        if ! grep -q "TASK \\[$tags :" "$phase_log"; then
            log_line "ERROR" "Phase tag=$tags executed no role tasks (possible tag propagation issue)."
            gum style --foreground "$NEON_RED" "  âœ— å¤±æ•— - no role tasks executed for '$tags' (see $LOG_FILE)"
            rm -f "$phase_log"
            return 1
        fi

        if grep -Eq "failed=[1-9]|unreachable=[1-9]" "$phase_log"; then
            log_line "ERROR" "Phase tag=$tags reported failures in recap despite success exit code."
            gum style --foreground "$NEON_RED" "  âœ— å¤±æ•— - failures detected in '$tags' recap (see $LOG_FILE)"
            rm -f "$phase_log"
            return 1
        fi

        log_line "INFO" "Completed phase tag=$tags successfully"
        rm -f "$phase_log"
        gum style --foreground "$NEON_GREEN" "  âœ“ å®Œäº†"
        return 0
    fi

    cat "$phase_log" >> "$LOG_FILE"
    log_line "ERROR" "Phase tag=$tags failed"
    rm -f "$phase_log"
    gum style --foreground "$NEON_RED" "  âœ— å¤±æ•— - $LOG_FILE"
    return 1
}

success_banner() {
    if [[ "$UI_MODE" != "fancy" ]]; then
        echo
        gum style --foreground "$NEON_GREEN" --bold "Install complete!"
        echo
        gum style --foreground "$NEON_CYAN" "  æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
        echo ""
        gum style --foreground "$DIM" "    exec zsh -l             ã‚·ã‚§ãƒ«ã‚’å†èª­ã¿è¾¼ã¿"
        gum style --foreground "$DIM" "    macmikase-theme <name>  ãƒ†ãƒ¼ãƒã‚’å¤‰æ›´"
        gum style --foreground "$DIM" "    macmikase               ãƒ¡ãƒ‹ãƒ¥ãƒ¼"
        gum style --foreground "$DIM" "    $LOG_FILE"
        echo ""
        return
    fi

    local g="\033[38;5;${NEON_GREEN}m"
    local r="\033[0m"

    echo ""
    echo ""
    echo -e "  ${g}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${r}"

    local inner_success
    inner_success=$(gum style --foreground "$NEON_GREEN" --width 76 --align center \
        "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—" \
        "â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•‘" \
        "â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘" \
        "â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•   â•šâ•â•" \
        "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—" \
        "â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â• â•šâ•â•")

    while IFS= read -r line; do
        echo -e "  ${g}â•‘${r}${line}${g}â•‘${r}"
    done <<< "$inner_success"

    echo -e "  ${g}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${r}"

    local inner_text
    inner_text=$(gum style --width 76 --align center \
        "$(echo -e "\033[38;5;${NEON_CYAN}mğŸŒ¸ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº† ğŸŒ¸\033[0m")" \
        "$(echo -e "\033[38;5;${DIM}mInstallation Complete\033[0m")")

    while IFS= read -r line; do
        echo -e "  ${g}â•‘${r}${line}${g}â•‘${r}"
    done <<< "$inner_text"

    echo -e "  ${g}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${r}"
    echo ""
    echo ""
    gum style --foreground "$NEON_CYAN" "  æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
    echo ""
    gum style --foreground "$DIM" "    exec zsh -l             ã‚·ã‚§ãƒ«ã‚’å†èª­ã¿è¾¼ã¿"
    gum style --foreground "$DIM" "    macmikase-theme <name>  ãƒ†ãƒ¼ãƒã‚’å¤‰æ›´"
    gum style --foreground "$DIM" "    macmikase               ãƒ¡ãƒ‹ãƒ¥ãƒ¼"
    gum style --foreground "$DIM" "    $LOG_FILE"
    echo ""
}

error_banner() {
    if [[ "$UI_MODE" != "fancy" ]]; then
        echo
        gum style --foreground "$NEON_RED" --bold "Install failed."
        gum style --foreground "$DIM" "  $LOG_FILE"
        echo ""
        return
    fi

    local red="\033[38;5;${NEON_RED}m"
    local r="\033[0m"

    echo ""
    echo ""
    echo -e "  ${red}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${r}"

    local inner_error
    inner_error=$(gum style --width 76 --align center \
        "$(echo -e "\033[38;5;${NEON_RED}mã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\033[0m")" \
        "$(echo -e "\033[38;5;${DIM}mAn error occurred\033[0m")")

    while IFS= read -r line; do
        echo -e "  ${red}â•‘${r}${line}${red}â•‘${r}"
    done <<< "$inner_error"

    echo -e "  ${red}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${r}"
    echo ""
    gum style --foreground "$DIM" "  $LOG_FILE"
    echo ""
}

main() {
    ensure_brew
    ensure_gum
    ensure_uv
    resolve_repo_dir
    validate_inputs

    {
        echo "=== MACMIKASE INSTALL LOG ==="
        echo "Started: $(date)"
        echo "Repo: $REPO_DIR"
        echo "Config: $CONFIG_FILE"
        echo ""
    } > "$LOG_FILE"
    log_line "INFO" "Installer started"
    trap 'stop_sudo_keepalive' EXIT

    banner

    gum style --foreground "$DIM" "  è¨­å®š: $CONFIG_FILE"
    show_install_plan
    echo ""

    if ! gum confirm \
        --prompt.foreground "$NEON_CYAN" \
        --selected.background "$NEON_PURPLE" \
        "  ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é–‹å§‹ã—ã¾ã™ã‹?"; then
        log_line "INFO" "Installer cancelled by user at confirmation"
        gum style --foreground "$NEON_ORANGE" "  ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
        exit 0
    fi

    ensure_sudo_session || {
        log_line "ERROR" "Install aborted before phases due to sudo authentication failure"
        error_banner
        exit 1
    }

    ensure_ansible_collections || {
        log_line "ERROR" "Ansible collections step failed"
        error_banner
        exit 1
    }

    phase_header "1" "4" "Homebrew" "Formulae, casks, fonts"
    run_ansible "homebrew" "homebrew" || {
        log_line "ERROR" "Install aborted during homebrew phase"
        error_banner
        exit 1
    }

    phase_header "2" "4" "Runtimes" "Rust, Go, Node, uv tools"
    run_ansible "runtimes" "runtimes" || {
        log_line "ERROR" "Install aborted during runtimes phase"
        error_banner
        exit 1
    }

    phase_header "3" "4" "Web Apps" "macOS app wrappers"
    run_ansible "web" "web" || {
        log_line "ERROR" "Install aborted during web phase"
        error_banner
        exit 1
    }

    phase_header "4" "4" "Dotfiles" "Shell, editor configs"
    run_ansible "dotfiles" "dotfiles" || {
        log_line "ERROR" "Install aborted during dotfiles phase"
        error_banner
        exit 1
    }

    log_line "INFO" "Installer completed successfully"
    success_banner
}

main "$@"
