#!/usr/bin/env bash
# macmikase-install - Japanese cyberpunk themed system installer for macOS
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
DEFAULT_CONFIG_FILE="$REPO_DIR/macmikase.yaml"
CONFIG_FILE="${CONFIG_FILE:-${MACMIKASE_CONFIG:-$DEFAULT_CONFIG_FILE}}"
LOG_FILE="/tmp/macmikase-install-$(date +%Y%m%d-%H%M%S).log"

usage() {
    cat << EOF
Usage: $(basename "$0") [options]

Options:
  -c, --config PATH   Path to macmikase.yaml (default: $CONFIG_FILE)
  -h, --help          Show this help message
EOF
}

while [[ $# -gt 0 ]]; do
    case "$1" in
        -c|--config)
            if [[ -z "${2:-}" ]]; then
                echo "Error: --config requires a path." >&2
                usage
                exit 1
            fi
            CONFIG_FILE="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            usage
            exit 1
            ;;
    esac
done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Colors - Cyberpunk Palette
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
NEON_PINK="212"
NEON_CYAN="51"
NEON_PURPLE="99"
NEON_GREEN="82"
NEON_ORANGE="208"
NEON_RED="196"
DIM="241"

find_brew_binary() {
    if command -v brew >/dev/null 2>&1; then
        command -v brew
        return 0
    fi
    if [[ -x /opt/homebrew/bin/brew ]]; then
        echo "/opt/homebrew/bin/brew"
        return 0
    fi
    if [[ -x /usr/local/bin/brew ]]; then
        echo "/usr/local/bin/brew"
        return 0
    fi
    return 1
}

activate_brew_shellenv() {
    local brew_cmd
    brew_cmd="$(find_brew_binary || true)"
    if [[ -z "$brew_cmd" ]]; then
        return 1
    fi
    eval "$("$brew_cmd" shellenv)"
}

ensure_brew() {
    if find_brew_binary >/dev/null 2>&1; then
        activate_brew_shellenv || true
        return
    fi
    echo "Homebrew not found. Installing..."
    local installer="/tmp/homebrew-install.sh"
    if ! curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh -o "$installer"; then
        echo "Error: failed to download Homebrew installer." >&2
        exit 1
    fi
    /bin/bash "$installer"
    rm -f "$installer"
    if ! activate_brew_shellenv; then
        echo "Error: Homebrew installation succeeded, but brew is not available on PATH." >&2
        exit 1
    fi
}

ensure_gum() {
    if command -v gum >/dev/null 2>&1; then
        return
    fi
    echo "gum not found. Installing..."
    local brew_cmd
    brew_cmd="$(find_brew_binary || true)"
    if [[ -z "$brew_cmd" ]]; then
        echo "Error: brew is required to install gum." >&2
        exit 1
    fi
    "$brew_cmd" install gum
}

ensure_uv() {
    if command -v uv >/dev/null 2>&1; then
        return
    fi
    if [[ -x "$HOME/.local/bin/uv" ]]; then
        export PATH="$HOME/.local/bin:$PATH"
        return
    fi
    if [[ -x /opt/homebrew/bin/uv ]]; then
        export PATH="/opt/homebrew/bin:$PATH"
        return
    fi
    if [[ -x /usr/local/bin/uv ]]; then
        export PATH="/usr/local/bin:$PATH"
        return
    fi
    echo "uv not found. Installing..."
    curl -LsSf https://astral.sh/uv/install.sh -o /tmp/uv-install.sh
    sh /tmp/uv-install.sh
    rm /tmp/uv-install.sh
    export PATH="$HOME/.local/bin:$PATH"
    if ! command -v uv >/dev/null 2>&1; then
        echo "Error: uv installation completed, but uv is not available on PATH." >&2
        exit 1
    fi
}

resolve_repo_dir() {
    if [[ -f "$REPO_DIR/ansible/playbook.yml" ]]; then
        return
    fi
    if [[ -f "$PWD/ansible/playbook.yml" ]]; then
        REPO_DIR="$PWD"
        if [[ "$CONFIG_FILE" == "$DEFAULT_CONFIG_FILE" ]]; then
            CONFIG_FILE="$REPO_DIR/macmikase.yaml"
        fi
    fi
}

validate_inputs() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        gum style --foreground "$NEON_RED" "  âœ— Config not found: $CONFIG_FILE"
        exit 1
    fi
    CONFIG_FILE="$(cd "$(dirname "$CONFIG_FILE")" && pwd)/$(basename "$CONFIG_FILE")"

    if [[ ! -f "$REPO_DIR/ansible/playbook.yml" ]]; then
        gum style --foreground "$NEON_RED" "  âœ— ansible/playbook.yml not found under: $REPO_DIR"
        gum style --foreground "$DIM" "  Run 'make install' from the repository root."
        exit 1
    fi
}

ensure_ansible_collections() {
    local requirements_file="$REPO_DIR/ansible/requirements.yml"
    if [[ ! -f "$requirements_file" ]]; then
        return 0
    fi

    if gum spin \
        --spinner.foreground "$NEON_PINK" \
        --title.foreground "$NEON_CYAN" \
        --spinner dot \
        --title "  ä¾å­˜é–¢ä¿‚... ansible collections" \
        -- bash -c "uv run --extra dev ansible-galaxy collection install -r '$requirements_file' >> '$LOG_FILE' 2>&1"; then
        gum style --foreground "$NEON_GREEN" "  âœ“ ansible collections"
        return 0
    fi

    gum style --foreground "$NEON_RED" "  âœ— ansible collections - $LOG_FILE"
    return 1
}

banner() {
    local p="\033[38;5;${NEON_PURPLE}m"
    local r="\033[0m"

    clear
    echo ""
    echo -e "  ${p}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${r}"

    local inner_ascii
    inner_ascii=$(gum style --foreground "$NEON_PINK" --width 76 --align center \
        "â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—" \
        "â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•" \
        "â–‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•â•â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘" \
        "â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–‘â•šâ•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–‘â•šâ•â•â•â–ˆâ–ˆâ•—" \
        "â–‘â–ˆâ–ˆâ•‘â–‘â•šâ•â•â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â•šâ•â•â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•" \
        "â–‘â•šâ•â•â–‘â–‘â–‘â–‘â–‘â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â•â•â•â•â–‘â–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â–‘â–‘â–‘â•šâ•â•â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â•â•â•â•")

    while IFS= read -r line; do
        echo -e "  ${p}â•‘${r}${line}${p}â•‘${r}"
    done <<< "$inner_ascii"

    echo -e "  ${p}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${r}"

    local inner_text
    inner_text=$(gum style --width 76 --align center \
        "$(echo -e "\033[38;5;${NEON_CYAN}mâ›©ï¸  ã‚·ã‚¹ãƒ†ãƒ è¨­å®š  â›©ï¸\033[0m")" \
        "$(echo -e "\033[38;5;${DIM}mmacOS System Configuration\033[0m")")

    while IFS= read -r line; do
        echo -e "  ${p}â•‘${r}${line}${p}â•‘${r}"
    done <<< "$inner_text"

    echo -e "  ${p}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${r}"
    echo ""
}

phase_header() {
    local num="$1"
    local total="$2"
    local title="$3"
    local subtitle="$4"

    local c="\033[38;5;${NEON_CYAN}m"
    local r="\033[0m"

    echo ""
    echo -e "  ${c}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${r}"

    local inner_phase
    inner_phase=$(gum style --width 76 --align left \
        "$(echo -e "  \033[38;5;${NEON_PINK}m[$num/$total] $title\033[0m")" \
        "$(echo -e "        \033[38;5;${DIM}m$subtitle\033[0m")")

    while IFS= read -r line; do
        echo -e "  ${c}â”‚${r}${line}${c}â”‚${r}"
    done <<< "$inner_phase"

    echo -e "  ${c}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${r}"
}

run_ansible() {
    local tags="$1"
    local desc="$2"

    cd "$REPO_DIR/ansible"

    if gum spin \
        --spinner.foreground "$NEON_PINK" \
        --title.foreground "$NEON_CYAN" \
        --spinner dot \
        --title "  å‡¦ç†ä¸­... $desc" \
        -- bash -c "uv run --extra dev ansible-playbook -i inventory.yml playbook.yml \
            -e 'config_file=$CONFIG_FILE' \
            --tags '$tags' >> '$LOG_FILE' 2>&1"; then
        gum style --foreground "$NEON_GREEN" "  âœ“ å®Œäº†"
        return 0
    else
        gum style --foreground "$NEON_RED" "  âœ— å¤±æ•— - $LOG_FILE"
        return 1
    fi
}

success_banner() {
    local g="\033[38;5;${NEON_GREEN}m"
    local r="\033[0m"

    echo ""
    echo ""
    echo -e "  ${g}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${r}"

    local inner_success
    inner_success=$(gum style --foreground "$NEON_GREEN" --width 76 --align center \
        "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—" \
        "â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•‘" \
        "â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘" \
        "â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•   â•šâ•â•" \
        "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—" \
        "â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â• â•šâ•â•")

    while IFS= read -r line; do
        echo -e "  ${g}â•‘${r}${line}${g}â•‘${r}"
    done <<< "$inner_success"

    echo -e "  ${g}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${r}"

    local inner_text
    inner_text=$(gum style --width 76 --align center \
        "$(echo -e "\033[38;5;${NEON_CYAN}mğŸŒ¸ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº† ğŸŒ¸\033[0m")" \
        "$(echo -e "\033[38;5;${DIM}mInstallation Complete\033[0m")")

    while IFS= read -r line; do
        echo -e "  ${g}â•‘${r}${line}${g}â•‘${r}"
    done <<< "$inner_text"

    echo -e "  ${g}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${r}"
    echo ""
    echo ""
    gum style --foreground "$NEON_CYAN" "  æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
    echo ""
    gum style --foreground "$DIM" "    exec zsh -l             ã‚·ã‚§ãƒ«ã‚’å†èª­ã¿è¾¼ã¿"
    gum style --foreground "$DIM" "    macmikase-theme <name>  ãƒ†ãƒ¼ãƒã‚’å¤‰æ›´"
    gum style --foreground "$DIM" "    macmikase               ãƒ¡ãƒ‹ãƒ¥ãƒ¼"
    gum style --foreground "$DIM" "    $LOG_FILE"
    echo ""
}

error_banner() {
    local red="\033[38;5;${NEON_RED}m"
    local r="\033[0m"

    echo ""
    echo ""
    echo -e "  ${red}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${r}"

    local inner_error
    inner_error=$(gum style --width 76 --align center \
        "$(echo -e "\033[38;5;${NEON_RED}mã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\033[0m")" \
        "$(echo -e "\033[38;5;${DIM}mAn error occurred\033[0m")")

    while IFS= read -r line; do
        echo -e "  ${red}â•‘${r}${line}${red}â•‘${r}"
    done <<< "$inner_error"

    echo -e "  ${red}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${r}"
    echo ""
    gum style --foreground "$DIM" "  $LOG_FILE"
    echo ""
}

main() {
    ensure_brew
    ensure_gum
    ensure_uv
    resolve_repo_dir
    validate_inputs

    banner

    gum style --foreground "$DIM" "  è¨­å®š: $CONFIG_FILE"
    echo ""

    if ! gum confirm \
        --prompt.foreground "$NEON_CYAN" \
        --selected.background "$NEON_PURPLE" \
        "  ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é–‹å§‹ã—ã¾ã™ã‹?"; then
        gum style --foreground "$NEON_ORANGE" "  ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
        exit 0
    fi

    {
        echo "=== MACMIKASE INSTALL LOG ==="
        echo "Started: $(date)"
        echo "Repo: $REPO_DIR"
        echo "Config: $CONFIG_FILE"
        echo ""
    } > "$LOG_FILE"

    ensure_ansible_collections || { error_banner; exit 1; }

    phase_header "1" "4" "Homebrew" "Formulae, casks, fonts"
    run_ansible "homebrew" "homebrew" || { error_banner; exit 1; }

    phase_header "2" "4" "Runtimes" "Rust, Go, Node, uv tools"
    run_ansible "runtimes" "runtimes" || { error_banner; exit 1; }

    phase_header "3" "4" "Web Apps" "macOS app wrappers"
    run_ansible "web" "web" || { error_banner; exit 1; }

    phase_header "4" "4" "Dotfiles" "Shell, editor configs"
    run_ansible "dotfiles" "dotfiles" || { error_banner; exit 1; }

    success_banner
}

main "$@"
