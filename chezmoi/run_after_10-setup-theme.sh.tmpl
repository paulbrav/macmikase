#!/bin/bash
# Run after chezmoi apply to set up theme files and reload applications
# This script delegates to helper scripts for per-app theme updates

set -euo pipefail

THEME="{{ .theme }}"
THEMES_DIR="{{ .themes_dir }}"
THEME_PATH="$THEMES_DIR/$THEME"
LOCAL_BIN="$HOME/.local/bin"

echo "Setting up theme: $THEME"

if [[ ! -d "$THEMES_DIR" ]]; then
    echo "Warning: Themes directory not found at $THEMES_DIR"
    echo "Run 'make install' to sync themes from the repository."
    exit 0
fi

if [[ ! -d "$THEME_PATH" ]]; then
    echo "Warning: Theme '$THEME' not found in $THEMES_DIR"
    exit 0
fi

# Apply macOS wallpaper from theme manifest (if available)
if [[ -f "$THEME_PATH/theme.yaml" ]]; then
    WALLPAPER_REL=$(
        awk -F': *' '$1=="wallpaper"{print $2; exit}' "$THEME_PATH/theme.yaml" \
            | sed 's/^"//; s/"$//'
    )
    if [[ -n "${WALLPAPER_REL:-}" ]]; then
        WALLPAPER_PATH="$THEME_PATH/$WALLPAPER_REL"
        if [[ -f "$WALLPAPER_PATH" ]]; then
            if command -v osascript >/dev/null 2>&1; then
                if WALLPAPER_RESULT=$(osascript - "$WALLPAPER_PATH" 2>&1 <<'APPLESCRIPT'
on run argv
    set wallpaperPath to POSIX file (item 1 of argv) as alias
    tell application "System Events"
        repeat with d in desktops
            set picture of d to wallpaperPath
        end repeat
    end tell
end run
APPLESCRIPT
                ); then
                    if [[ "$WALLPAPER_RESULT" != *"missing value"* ]]; then
                        echo "  - Set desktop wallpaper"
                    else
                        echo "  - Warning: Failed to set desktop wallpaper (received missing value)"
                    fi
                else
                    echo "  - Warning: Failed to set desktop wallpaper (check macOS Automation permissions)"
                fi
            fi
        else
            echo "  - Warning: Wallpaper file not found at $WALLPAPER_PATH"
        fi
    fi
fi

# Copy btop theme to btop themes directory
if [[ -f "$THEME_PATH/btop.theme" ]]; then
    mkdir -p ~/.config/btop/themes
    rm -f ~/.config/btop/themes/"$THEME.theme"
    cp "$THEME_PATH/btop.theme" ~/.config/btop/themes/"$THEME.theme"
    echo "  - Copied btop theme"
fi

# Copy opencode theme to opencode themes directory
if [[ -f "$THEME_PATH/opencode.json" ]]; then
    mkdir -p ~/.config/opencode/themes
    rm -f ~/.config/opencode/themes/"$THEME.json"
    cp "$THEME_PATH/opencode.json" ~/.config/opencode/themes/"$THEME.json"
    echo "  - Copied opencode theme"
fi

# Copy neovim theme
if [[ -f "$THEME_PATH/neovim.lua" ]] || [[ -f "$THEME_PATH/nvim.lua" ]]; then
    mkdir -p ~/.config/nvim/lua/macmikase
    rm -f ~/.config/nvim/lua/macmikase/theme.lua
    if [[ -f "$THEME_PATH/neovim.lua" ]]; then
        cp "$THEME_PATH/neovim.lua" ~/.config/nvim/lua/macmikase/theme.lua
    elif [[ -f "$THEME_PATH/nvim.lua" ]]; then
        cp "$THEME_PATH/nvim.lua" ~/.config/nvim/lua/macmikase/theme.lua
    fi
    echo "  - Copied neovim theme"
fi

# Reload terminal emulators
if [[ -x "$LOCAL_BIN/macmikase-theme-terminal" ]]; then
    echo "  - Reloading terminals..."
    "$LOCAL_BIN/macmikase-theme-terminal" --quiet || true
elif command -v macmikase-theme-terminal >/dev/null 2>&1; then
    echo "  - Reloading terminals..."
    macmikase-theme-terminal --quiet || true
else
    echo "  - Skipping terminal reload (helper not installed)"
fi

echo "Theme '$THEME' applied successfully!"
